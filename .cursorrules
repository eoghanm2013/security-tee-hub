# Security TEE Hub - Cursor Rules

## Context
This workspace is for Technical Escalation Engineers (TEEs) on Datadog's Security Products team. TEEs bridge the gap between Technical Support Engineers (TSEs) and Software Engineers (SWEs). When a TSE is stuck on an issue, they escalate to a TEE who investigates and determines if it's a bug that needs to go to engineering.

## API Access Constraints

### Atlassian (JIRA & Confluence)
- **READ-ONLY by default** â€” Never create, update, or comment on JIRA tickets or Confluence pages unless explicitly asked
- If asked to write, **always confirm** before executing
- JIRA project key for security escalations: `SCRS`
- Note: In the SCRS project, the "Issue Type" field is NOT reliable for categorization â€” focus on actual content (summary, description, labels) instead

### GitHub
- **READ-ONLY by default** â€” Never create branches, commits, PRs, issues, or push code unless explicitly asked
- If asked to write, **always confirm** before executing
- Use for searching Datadog codebases during investigations

### Slack
- When asked to check a Slack thread or given a Slack URL (dd.slack.com), **always use Glean search** to find the content
- Never attempt direct browser access to Slack URLs â€” they require authentication and won't work
- Slack messages are indexed in Glean and accessible through search

## Investigation Workflow

When asked to investigate a JIRA ticket:

### Step 1: Fetch the Ticket
Use MCP to pull the full ticket details including description and comments.

### Step 2: Assess Escalation Quality
Before diving into research, check if the TSE provided reasonable context:
- Environment details (tracer version, runtime, OS, hosting method)
- Relevant logs (actual debug logs, not just "I looked")
- What was tried and what happened
- Timestamps for reproduction attempts

**Be balanced** â€” not every ticket needs every piece of info. Requirements vary by issue complexity. Only flag what's actually needed to make progress.

### Step 3: If Critical Info Missing
Flag it clearly and provide a practical list of what the TSE should collect. Don't be overly strict â€” use judgment on what's actually blocking investigation.

### Step 4: If Sufficient Info
- **First:** Search for similar historical JIRA cases (match by symptoms/patterns, not just keywords)
- Check if this matches a documented pattern in `/docs/` or previous investigations
- If pattern found, reference it and adapt the solution
- **If no pattern:** Search relevant GitHub repos and Confluence docs
- Create investigation notes in `investigations/SCRS-XXXX/notes.md` and `response.md`

### Step 5: Risk Assessment for Configuration Changes
Before recommending any configuration changes, **always consider the repercussions**:

**Questions to ask:**
- What happens if this change breaks the application?
- Could this cause performance degradation or downtime?
- Is this a production system with traffic/users?
- Can this change be easily reverted?
- Do we have a rollback plan?
- Is there a safer way to test this hypothesis?

**Red flags:**
- Reducing resource limits (workers, connections, memory) â†’ may cause capacity issues
- Changing core process management settings â†’ may impact app availability
- Modifying security/auth configs â†’ may lock out users
- Adjusting timeouts too aggressively â†’ may break legitimate long operations

**Better approaches:**
- Suggest testing in staging/dev first if possible
- Recommend gradual changes with monitoring
- Provide rollback instructions upfront
- When unsure, escalate to engineering instead of guessing
- Document "what could go wrong" for the TSE/customer

**Lesson from SCRS-1885:** A seemingly logical fix (reducing PHP-FPM workers) caused application performance issues and didn't solve the underlying problem. Production config changes carry real risk.

## Folder Structure

```
security-tee-hub/
â”œâ”€â”€ investigations/     # Active investigations (SCRS-XXXX folders)
â”‚   â””â”€â”€ .template/      # Template for new investigations
â”œâ”€â”€ archive/            # Archived JIRA tickets by month (MM-YYYY/)
â”œâ”€â”€ docs/               # Internal documentation by product area
â”‚   â”œâ”€â”€ aap/            # App and API Protection (formerly appsec)
â”‚   â”œâ”€â”€ siem/           # Cloud SIEM
â”‚   â”œâ”€â”€ workload_protection/  # Workload Protection (formerly cws)
â”‚   â”œâ”€â”€ cspm/           # Cloud Security Misconfigurations
â”‚   â”œâ”€â”€ vm/             # Vulnerability Management
â”‚   â”œâ”€â”€ ciem/           # Identity Risk Management
â”‚   â”œâ”€â”€ sast/           # Static Application Security Testing
â”‚   â”œâ”€â”€ sca/            # Software Composition Analysis
â”‚   â”œâ”€â”€ iast/           # Interactive Application Security Testing
â”‚   â””â”€â”€ common/         # Cross-product docs
â”œâ”€â”€ reference/          # Reference materials
â””â”€â”€ scripts/            # Utility scripts (jira_client.py, bulk_archive.py)
```

## Product Areas
Source: [Security Products - Purpose, Required Data & Data Collection](https://datadoghq.atlassian.net/wiki/spaces/TS/pages/5213524529)

### Cloud Security
Slack: #support-cloud-security
- **CSPM** (Cloud Security Misconfigurations) â€” detect misconfigurations like overly permissive IAM, open buckets, insecure network settings. Data collected agentlessly via cloud integration.
- **VM** (Cloud Security Vulnerabilities) â€” scan OS packages and app libraries on hosts/container images for CVEs. Agent-based or agentless (12h cycle). Severity uses CVSS + CISA KEV + EPSS + runtime context.
- **CIEM** (Identity Risk Management) â€” analyse identities and permissions across AWS/Azure/GCP. Detects privilege escalation paths, overly permissive roles, cross-account access.

### Code Security
Slack: #support-code-security
- **SAST** (Static Application Security Testing) â€” scans first-party source code (no execution) for SQL injection, hardcoded creds, OWASP Top Ten. Runs in CI/CD or Datadog hosted scanning.
- **SCA** (Software Composition Analysis) â€” evaluates third-party dependencies for CVEs, license risks, outdated libraries. Static (CI/repo manifests) and Runtime (loaded libraries via tracing, `DD_APPSEC_SCA_ENABLED=true`).
- **IAST** (Interactive Application Security Testing) â€” detects exploitable code paths in live/synthetic traffic by tracing tainted data from sources to sinks. Enabled via `DD_IAST_ENABLED=true`.

### Threat Management
Slack: #support-security-threats
- **Cloud SIEM** â€” detection rules applied to all ingested logs to identify targeted attacks, insecure resource modifications, suspicious comms. Integrates with log management and content packs.
- **Workload Protection** (formerly CWS) â€” monitors system-level activities via eBPF (kernel 4.14+) on hosts/containers/K8s. Detects malicious process executions, FIM, DNS abuse. Also supports eBPF-less on Windows/Fargate.
- **AAP** (App and API Protection, formerly ASM/AppSec) â€” extends tracing library to inspect HTTP requests. Detects injection attacks, account takeover, app abuse. Includes In-App WAF. Enabled via `DD_APPSEC_ENABLED=true`.

## Tone
- Be helpful and practical
- Don't over-engineer solutions
- When escalation quality is poor, be constructive not harsh
- Focus on what's needed to make progress
- **Be cautious with production changes** â€” always consider what could go wrong
- When uncertain, recommend escalation over risky experimentation

## Communication Style for TSE Messages
When creating messages for TSEs to send:
- **Keep it concise** â€” Don't make it too long
- **Sound human** â€” Don't make it look AI-like (avoid overly formal or flowery language)
- **Use bold for emphasis** â€” You can **bolden** important words, but don't make text larger with headers
- **Be direct** â€” Get to the point quickly, technical audience doesn't need hand-holding

## Investigation Output Standards

### Brief-First Approach
When delivering investigation results:
1. **Start with TL;DR** (3-5 sentences maximum)
2. **Action items first** â€” What the TSE needs to do
3. **Explanation second** â€” Why this is happening (keep it short)
4. **Technical details last** â€” In investigation notes, not TSE messages

### Standardized File Structure
For each investigation, create ONLY these files:
- **`notes.md`** â€” Your detailed technical investigation (exhaustive, for TEE reference)
- **`response.md`** â€” Message for TSE to send to customer (concise, actionable, human-sounding)
- **`assets/`** â€” Folder for logs, screenshots, flares, etc.

**Do NOT create** multiple variations like `MESSAGE_TO_TSE.md`, `MESSAGE_SHORT.md`, `MESSAGE_BRIEF.md`, `SUMMARY.md`, `INDEX.md`, etc. unless explicitly requested.

### Pattern Recognition Workflow
**Before diving into deep investigation:**
1. Search for similar historical JIRA cases first (search by symptoms, not ticket number)
2. Check if this matches a known pattern from previous investigations
3. If pattern found, state: "This matches [pattern] from SCRS-XXXX" and reference the solution
4. Only do full greenfield investigation if no pattern matches

**Build pattern knowledge:**
- False positive patterns (e.g., linux-headers packages)
- Common API pagination mistakes (meta.page.after vs links.next)
- Configuration gaps (missing environment variables)
- Document these patterns in `/docs/` for future reference

### Risk Callouts (Always Include)
When recommending configuration changes or actions:
- **Environment:** Explicitly state prod vs non-prod vs dev
- **Risk level:** ðŸŸ¢ LOW / ðŸŸ¡ MEDIUM / ðŸ”´ HIGH with justification
- **What could go wrong:** Specific failure scenarios
- **Rollback plan:** How to undo the change
- **Testing approach:** Suggest safer validation methods when possible

### Investigation Discipline
- **Check rule/check definitions before concluding "bug":** When investigating compliance, SCAP, or detection failures, examine the rule's actual check logic (regex patterns, expected values, file paths) before concluding the agent is at fault. A "bug" that's actually a config mismatch is a common false positive.
- **Keep test environments alive until investigation is fully closed.** Don't purge VMs or test setups until all hypotheses have been tested. Spinning up a new environment to re-test something is wasted time.
- **One conclusion at a time.** Don't write findings into `response.md` or communicate them to the TSE until you're confident. It's better to say "still investigating" than to give an answer you'll need to walk back.
- **Screenshots aren't config.** When customer evidence is screenshots of terminal output, flag early that you can't parse it with full confidence. Ask for the actual file contents rather than trying to read text from images.

**Lesson from SCRS-1929:** Assumed a GNOME banner text compliance failure was an agent bug because it appeared alongside genuine agent bugs. Tested with wrong config (double quotes), saw it fail, and concluded "bug." Later discovered the OVAL rule requires single quotes â€” it was a config issue all along. Multiple wrong conclusions were communicated before landing on the right answer.

### Cleanup Practices
- **Test artifacts:** After validation, offer to remove test logs, scripts, and temporary files
- **Don't leave clutter:** If you create a test service or scripts for reproduction, clean them up when done
- **Ask before keeping:** "Should I keep these test files or clean them up?"

## Cloud Reproduction Environments

### CRITICAL: Sandbox Only
**All cloud resources for investigation and reproduction MUST use the designated Datadog sandbox environments. No exceptions.** Never create resources in production accounts, personal accounts, or any non-sandbox environment.

### CRITICAL: Confirm Before Launch
**Before executing the final command to create/launch any cloud resource, ALWAYS:**
1. Present a clear summary including: resource type, size/tier, region, tags, and what will be deployed
2. Ask the user for explicit permission to proceed
3. **Never launch without this confirmation step**

### Available Sandboxes
| Cloud | Name | ID | Access |
|---|---|---|---|
| **AWS** | `tse-sandbox` | Account: `659775407889` | [SSO Portal](https://d-906757b57c.awsapps.com/start/#/?tab=accounts) |
| **Azure** | `datadog-tse-sandbox` | Subscription: `768b21c7-b07b-49f7-974e-eb587918f832` | [Azure Portal (ddstaging)](https://portal.azure.com/ddstaging.onmicrosoft.com) |
| **GCP** | `datadog-tse-sandbox` | Check Project Picker | [GCP Console](https://console.cloud.google.com/) |

- **Azure login:** Use `@datadoghq.com` email (NOT `@devdatadoghq.com`)
- **AWS CLI:** Use `aws-vault` with the `sso-tse-sandbox-account-admin` profile
- **Access levels:** AWS AdministratorAccess, Azure Contributor, GCP Owner

### Mandatory Tagging
Every cloud resource created **must** have these tags:
- `creator:<firstname.lastname>`
- `team:<team-name>` (e.g., `team:technical-escalations-engineering`)
- `service:<cloud-service>` (e.g., `service:csm-investigation`)

### Security Rules
- **No resources exposed directly to the Internet** (all access through Appgate)
- **No production, customer, or sensitive data** in sandbox environments
- Cloud Security team **auto-remediates** insecure configs (e.g., open SSH inbound rules)
- Resources auto-deleted after **90 days** (notifications sent at 30 days, then daily at 3 days before deletion)
- For exceptions, file an [Auto-Remediation Exception Request](https://datadoghq.atlassian.net/jira/software/c/projects/CLOUDSEC/form/3428)

### Best Practices for Investigations
- **Tag with the SCRS ticket number** in the service tag (e.g., `service:scrs-1512-investigation`)
- **Tear down resources same day** when possible, don't leave things running overnight
- **Use the smallest resource that works** (e.g., `t3.micro` for basic agent testing)
- **Don't modify or delete resources you didn't create** unless confirmed with the owner
- **Never remove** cloud accounts/subscriptions from Demo Org `11287` or HQ Org `2`
- Check the [DataDog/sandbox repo](https://github.com/DataDog/sandbox) for pre-built Vagrant environments before building from scratch

### Confluence References
- [Team-Specific Cloud Sandboxes](https://datadoghq.atlassian.net/wiki/spaces/CLOUDA/pages/5129666770)
- [AWS, Azure, GCP Sandbox Environments for GSE](https://datadoghq.atlassian.net/wiki/spaces/TS/pages/328434517)
- [Sandbox Cloud Environment Security Policy](https://datadoghq.atlassian.net/wiki/spaces/SECENG/pages/4694639807)
- [Vagrant and Sandboxes](https://datadoghq.atlassian.net/wiki/spaces/TS/pages/4366600557)

